<div id="welcome">
  <div class="header">
    <h1>
      Projects I Follow
      <%= avatar_for(current_user, size: 132) %>
    </h1>
    
    <ul class="nav nav-pills">
      <li id="nav_timeline" class="active"><a href="#timeline">Timeline</a></li>
      <li id="nav_todo"><a href="#to-do">To Do</a></li>
    </ul>
  </div>
  
  <div id="triptych">
    <div id="timeline_body">
      <div class="timeline">
        <p class="spinner"><i class="icon-spinner icon-spin icon-large"></i> Loading...</p>
        <%= render "activity/events" %>
      </div>
    </div>
    
    <div id="todo_body" class="to-do out">
      <table>
        <tbody>
          <% @project_tdls.each do |project| %>
            <tr>
              <td>
                <b class="bubble <%= project.color %>"></b>
                <span class="project-name"><%= project.name %></span>
              </td>
              <td>
                <%= score_card :medium do |s| %>
                  <% s.score "Unprioritized<br/>Tickets".html_safe,
                             project.unprioritized_tickets,
                             project.score_options(:unprioritized_tickets) %>
                  <% s.score "Unestimated<br/>Tickets".html_safe,
                             project.unestimated_tickets,
                             project.score_options(:unestimated_tickets) %>
                  <% s.score "Pull Requests".html_safe,
                             project.pull_requests,
                             project.score_options(:pull_requests) %>
                  <% s.score "Failing Tickets".html_safe,
                             project.failing_tickets,
                             project.score_options(:failing_tickets) %>
                  <% s.score "Unreleased<br/>Commits".html_safe,
                             project.unreleased_commits,
                             project.score_options(:unreleased_commits) %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
  
</div>

<% content_for :javascripts do %>
<script type="text/javascript">
$(function() {
  new WelcomeView();
  var $window = $(window),
      $document = $(document),
      $timeline = $('.timeline'),
      offset = 50;
  $window.scroll(function () { 
    if($timeline.hasClass('loading')) { return; }
    if(!/#?timeline/.test(window.location.hash)) { return; }
    
    if($window.scrollTop() >= $document.height() - $window.height() - offset) {
      var time = $timeline.find('.timeline-event:last').attr('data-time');
      
      $timeline.addClass('loading');
      var xhr = $.get('/', {since: time});
      xhr.success(function(html) {
        $timeline.removeClass('loading');
        $('.timeline').append(html);
      });
      xhr.error(function() {
        $timeline.removeClass('loading');
      });
    }
  });
});
</script>
<% end %>
